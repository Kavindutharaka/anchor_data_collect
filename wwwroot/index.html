
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="keywords" content="Prasanthahv " />
    <meta name="description" content="Prasanthahv, phv " />

    <title>TB - Shop Visit</title>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="app.css" />
    <link rel="stylesheet" href="sup/animate.css" />

    <script type="text/javascript" src="sup/angular.min.js"></script>
    <script type="text/javascript" src="app.js?t=2874805"></script>
</head>
<body ng-app="PHVApp" ng-cloak ng-controller="HomeCtrl">

    <!-- Loading Overlay -->
    <div class="loading-overlay" ng-show="data_saveing > 0">
        <div ng-if="data_saveing == 1">
            <img src="loading.gif" />
            <div class="loading-text">Saving data...</div>
        </div>
        <div ng-if="data_saveing == 2" class="save-success-wrap">
            <div class="save-success-icon">&#10003;</div>
            <div class="save-success-text">Saved!</div>
        </div>
    </div>

    <!-- Root Code Panel Overlay -->
    <div class="rc-panel-overlay" ng-show="showRCPanel" ng-click="closeRCPanelOutside($event)">
        <div class="rc-panel" ng-click="$event.stopPropagation()">
            <div class="rc-panel-title">Select Root Code</div>
            <div class="rc-panel-sub">Select your assigned root code below. Required to submit visits.</div>

            <!-- Loading state -->
            <div ng-if="rcLoading" style="text-align:center;padding:24px 0;color:var(--text-secondary);font-size:14px;">
                Loading codes...
            </div>

            <!-- Code list from DB -->
            <div class="rc-saved-list" ng-if="!rcLoading && rcSavedCodes.length > 0">
                <div class="rc-saved-item" ng-repeat="c in rcSavedCodes"
                     ng-class="{active: c.code === rootCode}"
                     ng-click="selectRootCode(c.code)">
                    <div style="flex:1;min-width:0;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span class="rc-code-txt">{{c.code}}</span>
                            <span class="rc-active-tag" ng-if="c.code === rootCode">&#10003; Active</span>
                        </div>
                        <div ng-if="c.description" style="font-size:11px;color:var(--text-secondary);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{c.description}}</div>
                    </div>
                </div>
            </div>

            <!-- Empty state -->
            <div ng-if="!rcLoading && rcSavedCodes.length === 0"
                 style="text-align:center;padding:20px 0;color:var(--text-secondary);font-size:13px;">
                No root codes available. Contact your administrator.
            </div>

            <button type="button" class="rc-panel-close" ng-click="closeRCPanel()" ng-if="rootCode">Cancel</button>
        </div>
    </div>

    <div class="container">

        <!-- Fonterra Logo -->
        <div class="logo-header">
            <img src="logo/fonterra-masterbrand-logo.png" alt="Fonterra" ng-click="openRCPanel()" title="Click to set root code" />
        </div>

        <!-- Root Code Badge -->
        <div class="root-code-badge" ng-click="openRCPanel()">
            <span class="badge-inner">
                <span class="badge-dot" ng-class="{empty: !rootCode}"></span>
                <span ng-if="rootCode">{{rootCode}}</span>
                <span ng-if="!rootCode" style="color:var(--accent-red);">No Root Code Set</span>
            </span>
        </div>

        <div class="page-header">
            <h1>Shop Visit</h1>
        </div>

        <!-- Shop Name -->
        <div class="field-group">
            <label class="field-label">Shop Name</label>
            <input type="text" class="field-input" ng-model="shop_name" ng-change="loadgps()" placeholder="Enter shop name">
        </div>

        <!-- Owner Contact -->
        <div class="field-group">
            <label class="field-label">Shop Owner Contact</label>
            <input type="tel" class="field-input" ng-model="owner_contact" placeholder="Enter contact number">
        </div>

        <!-- Shop Address -->
        <div class="field-group">
            <label class="field-label">Shop Address</label>
            <input type="text" class="field-input" ng-model="shop_address" placeholder="Enter shop address">
        </div>

        <!-- Shop Name Board Picture -->
        <div class="field-group">
            <label class="field-label">Shop Name Board Picture</label>
            <div class="field-dual-btn">
                <button type="button" class="btn-upload" onclick="document.getElementById('fileBoard').click()">Upload Image</button>
                <button type="button" class="btn-cam" ng-click="openCameraFor('board')">Use Camera</button>
            </div>
            <input type="file" accept="image/*" id="fileBoard" style="display:none;" onchange="angular.element(this).scope().SelectFileBoard(event)">
        </div>
        <div ng-show="boardPreview" class="img-preview">
            <img ng-src="{{boardPreview}}" />
        </div>

        <!-- Live Location -->
        <div class="field-group">
            <label class="field-label">Live Location</label>
            <input type="text" class="field-input" ng-model="live_location" placeholder="Fetching GPS..." readonly>
        </div>

        <!-- Rack Before Picture -->
        <div class="field-group">
            <label class="field-label">Shop Product Rack Before Picture</label>
            <div class="field-dual-btn">
                <button type="button" class="btn-upload" onclick="document.getElementById('fileRackBefore').click()">Upload Image</button>
                <button type="button" class="btn-cam" ng-click="openCameraFor('rackBefore')">Use Camera</button>
            </div>
            <input type="file" accept="image/*" id="fileRackBefore" style="display:none;" onchange="angular.element(this).scope().SelectFileRackBefore(event)">
        </div>
        <div ng-show="rackBeforePreview" class="img-preview">
            <img ng-src="{{rackBeforePreview}}" />
        </div>

        <!-- Rack After Picture -->
        <div class="field-group">
            <label class="field-label">Shop Product Rack After Picture</label>
            <div class="field-dual-btn">
                <button type="button" class="btn-upload" onclick="document.getElementById('fileRackAfter').click()">Upload Image</button>
                <button type="button" class="btn-cam" ng-click="openCameraFor('rackAfter')">Use Camera</button>
            </div>
            <input type="file" accept="image/*" id="fileRackAfter" style="display:none;" onchange="angular.element(this).scope().SelectFileRackAfter(event)">
        </div>
        <div ng-show="rackAfterPreview" class="img-preview">
            <img ng-src="{{rackAfterPreview}}" />
        </div>

        <!-- Owner Signature -->
        <div class="field-group">
            <label class="field-label">Shop Owner Signature Picture</label>
            <div class="field-dual-btn">
                <button type="button" class="btn-upload" onclick="document.getElementById('fileSignature').click()">Upload Image</button>
                <button type="button" class="btn-cam" ng-click="openCameraFor('signature')">Use Camera</button>
            </div>
            <input type="file" accept="image/*" id="fileSignature" style="display:none;" onchange="angular.element(this).scope().SelectFileSignature(event)">
        </div>
        <div ng-show="signaturePreview" class="img-preview">
            <img ng-src="{{signaturePreview}}" />
        </div>

        <!-- Selfie with Shop (Camera Only) -->
        <div class="field-group">
            <label class="field-label">Selfie with Shop</label>
            <button type="button" class="btn-camera" ng-click="openCameraFor('selfie')">Open Camera & Capture</button>
        </div>
        <div ng-show="selfiePreview" class="img-preview">
            <img ng-src="{{selfiePreview}}" />
            <div class="timestamp-text">{{selfieTimestamp}}</div>
        </div>

        <!-- Reusable Camera Modal -->
        <div class="modal fade" id="cameraModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">{{cameraTitle}}</h5>
                        <button type="button" class="close" ng-click="closeCamera()" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" style="text-align:center;padding:8px;">
                        <video id="cameraVideo" autoplay playsinline style="width:100%;max-height:55vh;border-radius:6px;background:#000;"></video>
                        <canvas id="cameraCanvas" style="display:none;"></canvas>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary btn-block" ng-click="capturePhoto()" style="padding:12px;font-size:16px;">Capture</button>
                        <button type="button" class="btn btn-secondary btn-block" ng-click="closeCamera()" data-dismiss="modal" style="padding:12px;">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="btn-row">
            <button type="button" class="btn-save" ng-click="save()">Save</button>
            <button type="button" class="btn-new" ng-click="cls()">New</button>
        </div>

    </div>

</body>
</html>
